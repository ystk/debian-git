From: Markus Koschany <apo@debian.org>
Date: Fri, 7 Oct 2022 17:45:50 +0200
Subject: CVE-2021-40330

Origin: https://github.com/git/git/commit/a02ea577174ab8ed18f847cf1693f213e0b9c473
---
 connect.c             | 4 +++-
 t/t5570-git-daemon.sh | 5 +++++
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/connect.c b/connect.c
index e16e72d..e3a8046 100644
--- a/connect.c
+++ b/connect.c
@@ -675,11 +675,13 @@ struct child_process *git_connect(int fd[2], const char *url,
 		conn = NULL;
 	} else if (protocol == PROTO_GIT) {
 		transport_check_allowed("git");
+		char *target_host = xstrdup(hostandport);
+		if (strchr(target_host, '\n') || strchr(path, '\n'))
+			die(_("newline is forbidden in git:// hosts and repo paths"));
 
 		/* These underlying connection commands die() if they
 		 * cannot connect.
 		 */
-		char *target_host = xstrdup(hostandport);
 		if (git_use_proxy(hostandport))
 			conn = git_proxy_connect(fd, hostandport);
 		else
diff --git a/t/t5570-git-daemon.sh b/t/t5570-git-daemon.sh
index 6b16379..edc86b8 100755
--- a/t/t5570-git-daemon.sh
+++ b/t/t5570-git-daemon.sh
@@ -84,6 +84,11 @@ test_expect_success 'fetch notices corrupt idx' '
 	)
 '
 
+test_expect_success 'client refuses to ask for repo with newline' '
+	test_must_fail git clone "$GIT_DAEMON_URL/repo$LF.git" dst 2>stderr &&
+	test_i18ngrep newline.is.forbidden stderr
+'
+
 test_remote_error()
 {
 	do_export=YesPlease
