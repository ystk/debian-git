Backported of:


From 800a7f99a8776b18a48cf9c1b0f9418bf4644bbd Mon Sep 17 00:00:00 2001
From: Jeff Hostetler <jeffhost@microsoft.com>
Date: Mon, 15 Apr 2019 13:39:46 -0700
Subject: [PATCH] config: add read_very_early_config()

Created an even lighter version of read_early_config() that
only looks at system and global config settings.  It omits
repo-local, worktree-local, and command-line settings.

Signed-off-by: Jeff Hostetler <jeffhost@microsoft.com>
Signed-off-by: Junio C Hamano <gitster@pobox.com>
--- a/config.c
+++ b/config.c
@@ -1187,6 +1187,22 @@ int git_config_early(config_fn_t fn, voi
 	return ret == 0 ? found : ret;
 }
 
+/*
+ * Read config but only enumerate system and global settings.
+ * Omit any repo-local, worktree-local, or command-line settings.
+ */
+void read_very_early_config(config_fn_t cb, void *data)
+{
+	struct config_options opts = { 0 };
+
+	opts.respect_includes = 1;
+	opts.ignore_repo = 1;
+	opts.ignore_worktree = 1;
+	opts.ignore_cmdline = 1;
+
+	git_config_with_options(cb, data, NULL, &opts);
+}
+
 int git_config_with_options(config_fn_t fn, void *data,
 			    struct git_config_source *config_source,
 			    const struct config_options *opts)
--- a/cache.h
+++ b/cache.h
@@ -1313,6 +1313,9 @@ struct git_config_source {
 
 struct config_options {
 	unsigned int respect_includes : 1;
+	unsigned int ignore_repo : 1;
+	unsigned int ignore_worktree : 1;
+	unsigned int ignore_cmdline : 1;
 };
 
 typedef int (*config_fn_t)(const char *, const char *, void *);
@@ -1323,6 +1326,7 @@ extern int git_config_from_buf(config_fn
 extern void git_config_push_parameter(const char *text);
 extern int git_config_from_parameters(config_fn_t fn, void *data);
 extern void read_early_config(config_fn_t cb, void *data);
+extern void read_very_early_config(config_fn_t cb, void *data);
 extern void git_config(config_fn_t fn, void *);
 extern int git_config_with_options(config_fn_t fn, void *,
 				   struct git_config_source *config_source,
